{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>Stock Levels</h1>

    <!-- Sorting Dropdown -->
    <form method="GET" action="{{ url_for('stock_levels') }}">
        <label for="sort-by">Sort by: </label>
        <select name="sort-by" id="sort-by" onchange="this.form.submit()">
            <option value="expiry" {% if sort_by == 'expiry' %}selected{% endif %}>Expiry Date</option>
            <option value="weight" {% if sort_by == 'weight' %}selected{% endif %}>Weight</option>
        </select>
    </form>
    <br>
    <!-- Threshold Input Fields -->
    <div class="form-group1">
        <label for="weight-threshold">Weight (g):</label>
        <input type="number" id="weight-threshold" name="weight-threshold" step="0.01" min="0">
        <label for="expiry-threshold">Number of days:</label>
        <input type="number" id="expiry-threshold" name="expiry-threshold" min="1">
    </div>
    <button id="sp" type="button" onclick="highlightGroceries()">Apply</button>
    
    <!-- Legend for Color Codes -->
    <div class="legend">
        <h3>Legend</h3>
        <ul>
            <li><span class="highlight-weight"></span> Groceries about to run out (Red)</li>
            <li><span class="highlight-expiry"></span> Groceries about to expire (Yellow)</li>
            <li><span class="highlight-both"></span> Groceries about to run out and expire (Orange)</li>
        </ul>
    </div>
    <!-- Grocery Stock Table -->
    <table id="grocery-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Weight (g)</th>
                <th>Expiry Date</th>
                <th>Days Until Expiry</th>
            </tr>
        </thead>
        <tbody>
            {% for grocery in groceries %}
            <tr data-id="{{ grocery.id }}" data-weight="{{ grocery.weight }}" data-expiry="{{ grocery.expiry }}">
                <td>{{ grocery.id }}</td>
                <td>{{ grocery.name }}</td>
                <td>{{ grocery.weight }}</td>
                <td>{{ grocery.expiry }}</td>
                <td class="days-until-expiry"></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Expired Groceries Table -->
    <h2>Expired Groceries</h2>
    <table id="expired-grocery-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Weight (g)</th>
                <th>Expiry Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Expired groceries will be dynamically added here -->
        </tbody>
    </table>
</div>

<!-- JavaScript for highlighting rows and calculating days -->
<script>
    function calculateDaysUntilExpiry(expiryDateStr) {
        const today = new Date();
        const expiryDate = new Date(expiryDateStr);
        return Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
    }

    function highlightGroceries() {
        const weightThreshold = parseFloat(document.getElementById('weight-threshold').value);
        const expiryThreshold = parseInt(document.getElementById('expiry-threshold').value);

        const rows = document.querySelectorAll('#grocery-table tbody tr');
        const expiredTableBody = document.querySelector('#expired-grocery-table tbody');
        expiredTableBody.innerHTML = ''; // Clear previous entries

        rows.forEach(row => {
            const weight = parseFloat(row.getAttribute('data-weight'));
            const expiryDateStr = row.getAttribute('data-expiry');
            const daysUntilExpiry = calculateDaysUntilExpiry(expiryDateStr);
            const daysCell = row.querySelector('.days-until-expiry');

            daysCell.textContent = daysUntilExpiry;

            if (daysUntilExpiry < 0) {
                // Move to expired groceries table
                const clone = row.cloneNode(true);
                clone.querySelector('.days-until-expiry').textContent = 'Expired';
                expiredTableBody.appendChild(clone);
                row.remove();
            } else {
                // Apply highlighting logic for non-expired groceries
                let highlightClass = '';
                if (weightThreshold && weight < weightThreshold) {
                    highlightClass = 'highlight-weight';
                }
                if (expiryThreshold && daysUntilExpiry <= expiryThreshold) {
                    highlightClass = highlightClass ? 'highlight-both' : 'highlight-expiry';
                }
                row.className = highlightClass;
            }
        });
    }

    window.onload = highlightGroceries;
</script>

{% endblock %}
